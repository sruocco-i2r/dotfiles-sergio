# fix ssh agent when tmux is detached
setenv -g SSH_AUTH_SOCK $HOME/.ssh/ssh_auth_sock

# reload conf
bind-key R source-file ~/.tmux.conf \; display-message "new tmux.conf read"

# from /usr/share/doc/tmux/example_tmux.conf

# Enable RGB24 colour if running in xterm(1)
set -sa terminal-overrides ",xterm*:Tc"

# Change the default $TERM to tmux-256color
set -g default-terminal "tmux-256color"

# https://config.phundrak.com/tmux.html
tmux_conf_theme_24b_colour=true
tmux_conf_theme_pane_border_style=fat

# https://www.joshmedeski.com/posts/smart-tmux-sessions-with-zoxide-and-fzf/
set-option -g detach-on-destroy off

# https://www.fosslinux.com/106055/create-custom-tmux-key-bindings.htm
set-option -g repeat-time 1000
# set-option -g repeat-rate 20

# clipboard for KiTTY / PuTTY 
set -g set-clipboard on

# remap prefix from 'C-b' to 'C-Space'
unbind C-b
set-option -g prefix C-Space
bind-key C-Space send-prefix

# count from 1
set -g base-index 1

# renumber when windows are closed
set-option -g renumber-windows on

# (do not) rename windows based on the running command
set-option -g allow-rename off

set -g set-titles on
set -g set-titles-string "#T"

#setting the delay between prefix and command
set -s escape-time 1

# messages timeout
set-option -g display-time 2500

# shell256col.sh
# set pane-active-border-style fg=yellow

# set-option -g pane-active-border-style fg=orange

# disable to get white background for eink
# set -g window-style 'fg=colour243,bg=colour232'
# set -g window-active-style 'fg=colour252,bg=color232'

## set -g window-active-style 'fg=colour250,bg=colour232'


## monitor silence
set-window-option -g monitor-silence 60
set-window-option -g window-status-activity-style "reverse"


## OFF MODE

# Activate OFF mode
bind -n M-F12 \
    set prefix None \;\
    set key-table off \;\
    set status-style "fg=colour245,bg=colour238"

# Disable OFF mode
bind -T off M-F12 \
    set -u prefix \;\
    set -u key-table \;\
    set -u status-style


# POPUPS

# scratch session -- exit with disconnect?? recursive attach?!
#
# bind C-g display-popup -E "tmux attach"

# bind -n M-g display-popup -E "tmux new-session -A -s scratch"

# LAZYGIT
# [keys.normal]
# bind C-g = ":sh tmux popup -d \"#{pane_current_path}\" -xC -yC -w80% -h80% -E ]lazygit"
# bind -n M-G display-popup -w 95% -h 95% -d "#{pane_current_path}" -E "lazygit"

# bind -n M-G display-popup -w 95% -h 95% -E "lazygit"

bind-key C-g display-popup -d "#{pane_current_path}" -xC -yC -w100% -h100% -E lazygit


# split panes with | and -
bind \| split-window -h -c "#{pane_current_path}"
bind - split-window -v -c "#{pane_current_path}"
unbind '"'
unbind %

# break out and put back panes in windows
# https://www.reddit.com/r/tmux/comments/4s7xbn/comment/d5u5ok6/?utm_source=share&utm_medium=web2x&context=3
# 
bind-key m choose-window -F "#{window_index}: #{window_name}" "join-pane -h -t %%"
bind-key M choose-window -F "#{window_index}: #{window_name}" "join-pane -v -t %%"

# move in panes: ALT + arrows
bind -n m-Left  select-pane -L
bind -n m-Right select-pane -R
bind -n m-Up    select-pane -U
bind -n m-Down  select-pane -D

# resize panes: CTRL-SHIFT-<arrow>
# https://superuser.com/a/1560646
# you want repeat-time in tmux to be higher than the delay and the repeat interval in your keyboard settings

bind-key -r -T prefix       C-S-Up              resize-pane -U 5
bind-key -r -T prefix       C-S-Down            resize-pane -D 5
bind-key -r -T prefix       C-S-Left            resize-pane -L 5
bind-key -r -T prefix       C-S-Right           resize-pane -R 5
# bind-key -r -T prefix       C-Up              resize-pane -U
# bind-key -r -T prefix       C-Down            resize-pane -D
# bind-key -r -T prefix       C-Left            resize-pane -L
# bind-key -r -T prefix       C-Right           resize-pane -R

# Set the history limit so we get lots of scrollback.
setw -g history-limit 50000000

# switch to prev/next window: SHIFT-LEFT/RIGHT 
bind-key -n S-Left previous-window
bind-key -n S-Right next-window

# move current window left/right
bind-key -n C-S-Left swap-window -t -1\; select-window -t -1
bind-key -n C-S-Right swap-window -t +1\; select-window -t +1

# scrolling with mouse wheels https://stackoverflow.com/a/33461197
bind -n WheelUpPane if-shell -F -t = "#{mouse_any_flag}" "send-keys -M" "if -Ft= '#{pane_in_mode}' 'send-keys -M' 'select-pane -t=; copy-mode -e; send-keys -M'"
bind -n WheelDownPane select-pane -t= \; send-keys -M

# Toggle between smallest and largest sizes if a window is visible in multiple places
bind F set -w window-size

# list of plugins
set -g @plugin 'tmux-plugins/tpm'

# (disabled) Hide the status when not used https://github.com/TheSast/tmux-transient-status
# set -g @plugin 'thesast/tmux-transient-status'

# smart naming for windows https://github.com/ofirgall/tmux-window-name
set -g @plugin 'ofirgall/tmux-window-name'

# unbind -n MouseDrag1Pane
# unbind -Tcopy-mode MouseDrag1Pane

# tmux Taster
# bind-key -t vi-copy 'v' begin-selection
# bind-key -t vi-copy 'y' copy-pipe "xclip"

# Turn the mouse on, but without copy mode dragging
set -g mouse on

# https://www.seanh.cc/2020/12/27/copy-and-paste-in-tmux/

bind -T copy-mode    DoubleClick1Pane select-pane \; send -X select-word \; send -X copy-pipe-no-clear "xsel -i"
bind -T copy-mode-vi DoubleClick1Pane select-pane \; send -X select-word \; send -X copy-pipe-no-clear "xsel -i"
bind -n DoubleClick1Pane select-pane \; copy-mode -M \; send -X select-word \; send -X copy-pipe-no-clear "xsel -i"
bind -T copy-mode    TripleClick1Pane select-pane \; send -X select-line \; send -X copy-pipe-no-clear "xsel -i"
bind -T copy-mode-vi TripleClick1Pane select-pane \; send -X select-line \; send -X copy-pipe-no-clear "xsel -i"
bind -n TripleClick1Pane select-pane \; copy-mode -M \; send -X select-line \; send -X copy-pipe-no-clear "xsel -i"

set -g @plugin 'tmux-plugins/tmux-yank'
set -g @yank_action 'copy-pipe-no-clear'

bind -T copy-mode    C-c send -X copy-pipe-no-clear "xsel -i --clipboard"
bind -T copy-mode-vi C-c send -X copy-pipe-no-clear "xsel -i --clipboard"

# bind "begin-selection" to CTRL-b
unbind C-Space
unbind C-b
bind-key -T copy-mode C-b send-keys -X begin-selection

## bind -n MouseDown2Pane run "tmux set-buffer -b primary_selection \"$(xsel -o)\"; tmux paste-buffer -b primary_selection; tmux delete-buffer -b primary_selection"

set -g @plugin 'tmux-plugins/tmux-sensible'

set -g @plugin 'jimeh/tmux-themepack'
# set -g @themepack 'basic'
set -g @themepack 'emass'

set -g @plugin 'jimeh/tmuxifier'

# 
# https://github.com/sbernheim4/dotfiles/blob/251a30db0dbbd2953df35bfa0ef43e92ce15b752/tmux/.tmux.conf#L1
# 

# tpm/docs/automatic_tpm_installation.md
if "test ! -d ~/.tmux/plugins/tpm" \
   "run 'git clone https://github.com/tmux-plugins/tpm ~/.tmux/plugins/tpm && ~/.tmux/plugins/tpm/bin/install_plugins'"

# Initialize TMUX plugin manager (keep this line at the very bottom of tmux.conf)
run '~/.tmux/plugins/tpm/tpm'
